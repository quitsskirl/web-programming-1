<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mental Health | Professor Settings</title>
  
  <!-- ==================== BOOTSTRAP CSS ==================== -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Link to settings page styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='Settings1.css') }}">
</head>
<body>

  <!-- ========== LOADING SCREEN ========== -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-content">
      <div class="leaf-loader">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>
      <p class="loading-text">Loading<span class="dots"></span></p>
    </div>
  </div>

  <!-- ========== HEADER ========== -->
  <header>
    <div class="header-left">
      <button id="menuBtn" class="menu-icon" title="Open Menu">&#9776;</button>
      <h2>Settings</h2>
    </div>
    <div class="header-right">
      <button id="userBtn" class="user-icon" title="View Account">üë§</button>
      <div id="userPopup" class="user-popup">
        <h3 id="popupUsername">Username: Professional</h3>
        <p id="popupRole">Role: Counselor</p>
      </div>
    </div>
  </header>

  <!-- ========== SIDE NAVIGATION MENU (PROFESSOR) ========== -->
  <nav id="sideMenu" class="side-menu" aria-hidden="true">
    <button id="closeMenu" class="close-btn" title="Close Menu">&times;</button>
    <h3>Menu</h3>
    <a href="{{ url_for('hp_professor.home_professor_page') }}">üè† Home Page</a>
    <a href="{{ url_for('appointments.my_appointments') }}">üìã My Appointments</a>
    <a href="{{ url_for('resources.resources_professor_page') }}">üìö Manage Resources</a>
    <a class="active" href="{{ url_for('settings.settings_professor_page') }}">‚öôÔ∏è Settings</a>
  </nav>

  <!-- ========== MAIN CONTENT ========== -->
  <main class="container">

    <!-- ===== PROFILE INFO BOX ===== -->
    <section class="profile-box">
      <h3><i class="bi bi-person-badge"></i> Professional Profile</h3>
      <p><strong>Username:</strong> <span id="profileUsername">Loading...</span></p>
      <p><strong>Specialty:</strong> <span id="profileSpecialty">Loading...</span></p>
      <p><strong>Role:</strong> <span id="profileRole">Professional</span></p>
    </section>

    <!-- ===== ACCOUNT SETTINGS ===== -->
    <section class="account-settings">
      <h3><i class="bi bi-shield-lock"></i> Security & Preferences</h3>
      
      <!-- Setting action buttons -->
      <button class="primary" id="btnChangePass">
        <i class="bi bi-key"></i> Change Password
      </button>
      <button class="primary" id="btnNotifications">
        <i class="bi bi-bell"></i> Notification Preferences
      </button>
      <button class="primary" id="btnUpdateProfile">
        <i class="bi bi-pencil"></i> Update Profile
      </button>

      <!-- Hidden form: Change Password -->
      <div class="hidden-form" id="formChangePass">
        <h4><i class="bi bi-lock"></i> Change Password</h4>
        <form id="changePassForm">
          <label for="oldPass">Current Password</label>
          <input type="password" id="oldPass" name="oldPass" placeholder="Enter current password" required>
          <label for="newPass">New Password</label>
          <input type="password" id="newPass" name="newPass" placeholder="Enter new password" required>
          <button type="submit" class="primary">
            <i class="bi bi-check-lg"></i> Update Password
          </button>
        </form>
      </div>

      <!-- Hidden form: Notification Settings -->
      <div class="hidden-form" id="formNotifications">
        <h4><i class="bi bi-bell"></i> Notification Preferences</h4>
        <form id="notifForm">
          <label><input type="checkbox" name="emailNot" checked> Email notifications for new appointments</label>
          <label><input type="checkbox" name="smsNot"> SMS notifications</label>
          <label><input type="checkbox" name="reminderNot" checked> Appointment reminders</label>
          <button type="submit" class="primary">
            <i class="bi bi-check-lg"></i> Save Preferences
          </button>
        </form>
      </div>

      <!-- Hidden form: Update Profile -->
      <div class="hidden-form" id="formUpdateProfile">
        <h4><i class="bi bi-person-badge"></i> Update Profile</h4>
        <form id="profileForm">
          <label for="specialty">Specialty</label>
          <select id="specialty" name="specialty">
            <option value="General Counselor">General Counselor</option>
            <option value="Mental Health Counselor">Mental Health Counselor</option>
            <option value="Academic Advisor">Academic Advisor</option>
            <option value="Psychologist">Psychologist</option>
            <option value="Career Counselor">Career Counselor</option>
          </select>
          <label for="bio">Bio</label>
          <textarea id="bio" name="bio" rows="3" placeholder="Tell students about yourself..."></textarea>
          <button type="submit" class="primary">
            <i class="bi bi-check-lg"></i> Save Profile
          </button>
        </form>
      </div>
    </section>

    <!-- ===== DANGER ZONE ===== -->
    <section class="danger-zone">
      <h3><i class="bi bi-exclamation-triangle"></i> Danger Zone</h3>
      <div class="button-group">
        <button class="delete-btn" id="btnDeleteAccount">
          <i class="bi bi-trash"></i> Delete Account
        </button>
        <button class="logout-btn" id="btnLogOut">
          <i class="bi bi-box-arrow-right"></i> Log Out
        </button>
      </div>
    </section>

  </main>

  <!-- ==================== BOOTSTRAP JAVASCRIPT ==================== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ========== PAGE SCRIPTS ========== -->
  <script>
  (function() {
    // Hide loading screen when page is fully loaded
    window.addEventListener('load', function() {
      const loadingScreen = document.getElementById('loadingScreen');
      setTimeout(function() {
        loadingScreen.classList.add('hidden');
      }, 800);
    });

    // DOM elements
    const menuBtn = document.getElementById('menuBtn');
    const sideMenu = document.getElementById('sideMenu');
    const closeMenu = document.getElementById('closeMenu');
    const userBtn = document.getElementById('userBtn');
    const userPopup = document.getElementById('userPopup');

    // Settings buttons
    const btnChangePass = document.getElementById('btnChangePass');
    const btnNotifications = document.getElementById('btnNotifications');
    const btnUpdateProfile = document.getElementById('btnUpdateProfile');
    const btnLogOut = document.getElementById('btnLogOut');
    const btnDeleteAccount = document.getElementById('btnDeleteAccount');

    // Hidden forms
    const formChangePass = document.getElementById('formChangePass');
    const formNotifications = document.getElementById('formNotifications');
    const formUpdateProfile = document.getElementById('formUpdateProfile');

    // Load user info on page load
    document.addEventListener('DOMContentLoaded', () => {
      const username = localStorage.getItem('username') || 'Professional';
      const specialty = localStorage.getItem('specialty') || 'General Counselor';
      
      document.getElementById('profileUsername').textContent = username;
      document.getElementById('profileSpecialty').textContent = specialty;
      document.getElementById('popupUsername').textContent = `Username: ${username}`;
    });

    // Toggle hidden forms
    function toggleForm(form) {
      const forms = [formChangePass, formNotifications, formUpdateProfile];
      forms.forEach(f => {
        if (f === form) {
          f.style.display = f.style.display === 'block' ? 'none' : 'block';
        } else {
          f.style.display = 'none';
        }
      });
    }

    btnChangePass.addEventListener('click', () => toggleForm(formChangePass));
    btnNotifications.addEventListener('click', () => toggleForm(formNotifications));
    btnUpdateProfile.addEventListener('click', () => toggleForm(formUpdateProfile));

    // Log out
    btnLogOut.addEventListener('click', () => {
      localStorage.clear();
      document.cookie = 'jwt_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
      window.location.href = '/';  // Redirect to first page
    });

    // Delete account
    btnDeleteAccount.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete your account? This action cannot be undone!')) {
        return;
      }
      
      const token = localStorage.getItem('token');
      
      if (!token) {
        alert('You must be logged in to delete your account.');
        return;
      }
      
      try {
        const response = await fetch('/api/professional/delete', {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert(data.message);
          localStorage.clear();
          document.cookie = 'jwt_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
          window.location.href = '/';  // Redirect to first page
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Could not delete account. Please try again.');
      }
    });

    // Update profile form submission
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = localStorage.getItem('token');
      const specialty = document.getElementById('specialty').value;
      const bio = document.getElementById('bio').value;

      try {
        const response = await fetch('/api/professional/update', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ specialty, bio })
        });

        const data = await response.json();
        if (response.ok) {
          alert('Profile updated successfully!');
          localStorage.setItem('specialty', specialty);
          document.getElementById('profileSpecialty').textContent = specialty;
          formUpdateProfile.style.display = 'none';
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Update error:', error);
        alert('Could not update profile. Please try again.');
      }
    });

    // Menu controls
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sideMenu.classList.add('open');
      sideMenu.setAttribute('aria-hidden', 'false');
    });

    closeMenu.addEventListener('click', (e) => {
      e.stopPropagation();
      sideMenu.classList.remove('open');
      sideMenu.setAttribute('aria-hidden', 'true');
    });

    document.addEventListener('click', (e) => {
      if (!sideMenu.contains(e.target) && e.target !== menuBtn) {
        sideMenu.classList.remove('open');
        sideMenu.setAttribute('aria-hidden', 'true');
      }
    });

    // User popup
    userBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      userPopup.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!userPopup.contains(e.target) && e.target !== userBtn) {
        userPopup.classList.remove('active');
      }
    });
  })();
  </script>

</body>
</html>

