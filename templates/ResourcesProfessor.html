<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mental Health | Manage Resources</title>
  
  <!-- ==================== BOOTSTRAP CSS ==================== -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Link to professor resources page styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='ResourcesProfessor.css') }}">
  <!-- Custom Leaf Cursor -->
  <link rel="stylesheet" href="{{ url_for('static', filename='custom-cursor.css') }}">
</head>
<body>

<!-- ========== LOADING SCREEN ========== -->
<div id="loadingScreen" class="loading-screen">
  <div class="loading-content">
    <div class="leaf-loader">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
    <p class="loading-text">Loading<span class="dots"></span></p>
  </div>
</div>

<!-- ========== HEADER ========== -->
<header>
  <div class="header-left">
    <button id="menuBtn" class="menu-icon" title="Open Menu">&#9776;</button>
    <h2>Manage Resources</h2>
  </div>
  <div class="header-right">
    <button id="userBtn" class="user-icon" title="View Account">üë§</button>
    <div id="userPopup" class="user-popup">
      <h3 id="username">Username: Professional</h3>
      <p id="userRole">Role: Counselor</p>
    </div>
  </div>
</header>

<!-- ========== SIDE NAVIGATION MENU (PROFESSOR) ========== -->
<nav id="sideMenu" class="side-menu" aria-hidden="true">
  <button id="closeMenu" class="close-btn" title="Close Menu">&times;</button>
  <h3>Menu</h3>
  <a href="{{ url_for('hp_professor.home_professor_page') }}">üè† Home Page</a>
  <a href="{{ url_for('appointments.my_appointments') }}">üìã My Appointments</a>
  <a class="active" href="{{ url_for('resources.resources_professor_page') }}">üìö Manage Resources</a>
  <a href="{{ url_for('settings.settings_professor_page') }}">‚öôÔ∏è Settings</a>
</nav>

<!-- ========== MAIN CONTENT ========== -->
<main class="container">
  
  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1><i class="bi bi-folder-plus"></i> Resource Management</h1>
      <p class="subtitle">Upload and manage PDF resources for students</p>
    </div>
  </div>

  <!-- Upload Section -->
  <section class="upload-section">
    <h2><i class="bi bi-cloud-upload"></i> Upload New PDF</h2>
    
    <form id="uploadForm" enctype="multipart/form-data">
      <div class="form-row">
        <div class="form-group">
          <label for="title"><i class="bi bi-type"></i> Title</label>
          <input type="text" id="title" name="title" placeholder="Enter resource title..." required>
        </div>
        
        <div class="form-group">
          <label for="category"><i class="bi bi-tag"></i> Category</label>
          <select id="category" name="category">
            <option value="article">Articles & Guides</option>
            <option value="video">Videos & Tutorials</option>
            <option value="worksheet">Worksheets</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="description"><i class="bi bi-text-paragraph"></i> Description</label>
        <textarea id="description" name="description" rows="2" placeholder="Brief description of the resource..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="pdfFile"><i class="bi bi-file-pdf"></i> PDF File</label>
        <div class="file-input-wrapper">
          <input type="file" id="pdfFile" name="file" accept=".pdf" required>
          <div class="file-preview" id="filePreview">
            <i class="bi bi-file-earmark-pdf"></i>
            <span>Drop PDF here or click to browse</span>
          </div>
        </div>
      </div>
      
      <button type="submit" class="btn-upload" id="uploadBtn">
        <i class="bi bi-upload"></i> Upload PDF
      </button>
    </form>
    
    <!-- Upload Status Message -->
    <div id="uploadMessage" class="upload-message" style="display: none;"></div>
  </section>

  <!-- Add Video Section -->
  <section class="upload-section video-section">
    <h2><i class="bi bi-play-circle"></i> Add Video Link</h2>
    
    <form id="videoForm">
      <div class="form-row">
        <div class="form-group">
          <label for="videoTitle"><i class="bi bi-type"></i> Video Title</label>
          <input type="text" id="videoTitle" name="title" placeholder="Enter video title..." required>
        </div>
        
        <div class="form-group">
          <label for="videoUrl"><i class="bi bi-link-45deg"></i> Video URL</label>
          <input type="url" id="videoUrl" name="video_url" placeholder="https://youtube.com/watch?v=..." required>
        </div>
      </div>
      
      <div class="form-group">
        <label for="videoDescription"><i class="bi bi-text-paragraph"></i> Description</label>
        <textarea id="videoDescription" name="description" rows="2" placeholder="Brief description of the video..."></textarea>
      </div>
      
      <button type="submit" class="btn-upload btn-video" id="addVideoBtn">
        <i class="bi bi-plus-circle"></i> Add Video
      </button>
    </form>
    
    <!-- Video Status Message -->
    <div id="videoMessage" class="upload-message" style="display: none;"></div>
  </section>

  <!-- Resources List -->
  <section class="resources-section">
    <h2><i class="bi bi-collection"></i> Uploaded Resources</h2>
    
    <div class="resources-list" id="resourcesList">
      <!-- Resources will be loaded here dynamically -->
      <div class="loading-placeholder">
        <i class="bi bi-hourglass-split"></i>
        <p>Loading resources...</p>
      </div>
    </div>
  </section>

</main>

<!-- ========== EDIT RESOURCE MODAL ========== -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square text-primary"></i> Edit Resource</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editResourceForm">
          <input type="hidden" id="editResourceId">
          <input type="hidden" id="editResourceType">
          
          <div class="mb-3">
            <label for="editTitle" class="form-label"><i class="bi bi-type"></i> Title</label>
            <input type="text" class="form-control" id="editTitle" placeholder="Enter resource title..." required>
          </div>
          
          <div class="mb-3">
            <label for="editDescription" class="form-label"><i class="bi bi-text-paragraph"></i> Description</label>
            <textarea class="form-control" id="editDescription" rows="3" placeholder="Brief description..."></textarea>
          </div>
          
          <div class="mb-3" id="editVideoUrlGroup" style="display: none;">
            <label for="editVideoUrl" class="form-label"><i class="bi bi-link-45deg"></i> Video URL</label>
            <input type="url" class="form-control" id="editVideoUrl" placeholder="https://youtube.com/watch?v=...">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmEditBtn"><i class="bi bi-check-lg"></i> Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== DELETE CONFIRMATION MODAL ========== -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger"></i> Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete "<strong id="deleteResourceTitle"></strong>"?</p>
        <p class="text-muted small">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== BOOTSTRAP JAVASCRIPT ==================== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ========== PAGE SCRIPTS ========== -->
<script>
(function() {
  // Hide loading screen when page is fully loaded
  window.addEventListener('load', function() {
    const loadingScreen = document.getElementById('loadingScreen');
    setTimeout(function() {
      loadingScreen.classList.add('hidden');
    }, 800);
  });

  // DOM Elements
  const menuBtn = document.getElementById('menuBtn');
  const sideMenu = document.getElementById('sideMenu');
  const closeMenu = document.getElementById('closeMenu');
  const userBtn = document.getElementById('userBtn');
  const userPopup = document.getElementById('userPopup');
  const uploadForm = document.getElementById('uploadForm');
  const videoForm = document.getElementById('videoForm');
  const resourcesList = document.getElementById('resourcesList');
  const uploadMessage = document.getElementById('uploadMessage');
  const videoMessage = document.getElementById('videoMessage');
  const fileInput = document.getElementById('pdfFile');
  const filePreview = document.getElementById('filePreview');
  
  let deleteResourceId = null;
  const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
  const editModal = new bootstrap.Modal(document.getElementById('editModal'));

  // Load user info
  document.addEventListener('DOMContentLoaded', () => {
    const username = localStorage.getItem('username') || 'Professional';
    document.getElementById('username').textContent = `Username: ${username}`;
    loadResources();
  });

  // Video form submission
  videoForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const token = localStorage.getItem('token');
    if (!token) {
      showVideoMessage('Please log in to add videos.', true);
      return;
    }
    
    const addVideoBtn = document.getElementById('addVideoBtn');
    addVideoBtn.disabled = true;
    addVideoBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
    
    const videoData = {
      title: document.getElementById('videoTitle').value,
      video_url: document.getElementById('videoUrl').value,
      description: document.getElementById('videoDescription').value
    };
    
    try {
      const response = await fetch('/api/resources/add-video', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(videoData)
      });
      
      const data = await response.json();
      
      if (response.ok) {
        showVideoMessage('Video added successfully!', false);
        videoForm.reset();
        loadResources();
      } else {
        showVideoMessage(data.message || 'Failed to add video.', true);
      }
    } catch (error) {
      console.error('Video error:', error);
      showVideoMessage('Could not add video. Please try again.', true);
    } finally {
      addVideoBtn.disabled = false;
      addVideoBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Add Video';
    }
  });

  // Show video message helper
  function showVideoMessage(message, isError) {
    videoMessage.textContent = message;
    videoMessage.className = 'upload-message ' + (isError ? 'error' : 'success');
    videoMessage.style.display = 'block';
    
    setTimeout(() => {
      videoMessage.style.display = 'none';
    }, 5000);
  }

  // File input preview
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      filePreview.innerHTML = `
        <i class="bi bi-file-earmark-pdf-fill"></i>
        <span>${file.name}</span>
        <small>${(file.size / 1024 / 1024).toFixed(2)} MB</small>
      `;
      filePreview.classList.add('has-file');
    }
  });

  // Upload form submission
  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const token = localStorage.getItem('token');
    if (!token) {
      showMessage('Please log in to upload resources.', true);
      return;
    }
    
    const formData = new FormData(uploadForm);
    const uploadBtn = document.getElementById('uploadBtn');
    
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Uploading...';
    
    try {
      const response = await fetch('/api/resources/upload-pdf', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (response.ok) {
        showMessage('PDF uploaded successfully!', false);
        uploadForm.reset();
        filePreview.innerHTML = `
          <i class="bi bi-file-earmark-pdf"></i>
          <span>Drop PDF here or click to browse</span>
        `;
        filePreview.classList.remove('has-file');
        loadResources();
      } else {
        showMessage(data.message || 'Upload failed.', true);
      }
    } catch (error) {
      console.error('Upload error:', error);
      showMessage('Could not upload file. Please try again.', true);
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Upload PDF';
    }
  });

  // Load resources from API (both PDFs and Videos)
  async function loadResources() {
    try {
      // Load both PDFs and videos
      const [pdfResponse, videoResponse] = await Promise.all([
        fetch('/api/resources/pdfs'),
        fetch('/api/resources/videos')
      ]);
      
      const pdfs = await pdfResponse.json();
      const videos = await videoResponse.json();
      
      // Combine and check if empty
      const allResources = [...(Array.isArray(pdfs) ? pdfs : []), ...(Array.isArray(videos) ? videos : [])];
      
      if (allResources.length === 0) {
        resourcesList.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-folder2-open"></i>
            <h3>No Resources Yet</h3>
            <p>Upload your first PDF or add a video link above.</p>
          </div>
        `;
        return;
      }
      
      // Build HTML for each resource type
      let html = '';
      
      // PDFs section
      if (pdfs.length > 0) {
        html += `<h3 class="resource-type-header"><i class="bi bi-file-pdf"></i> PDF Documents (${pdfs.length})</h3>`;
        html += pdfs.map(r => `
          <div class="resource-card pdf" data-id="${r._id}">
            <div class="resource-icon pdf-icon-bg">
              <i class="bi bi-file-earmark-pdf-fill"></i>
            </div>
            <div class="resource-info">
              <h3>${escapeHtml(r.title)}</h3>
              <p>${escapeHtml(r.description || 'No description')}</p>
              <div class="resource-meta">
                <span><i class="bi bi-person"></i> ${escapeHtml(r.uploaded_by || 'Unknown')}</span>
              </div>
            </div>
            <div class="resource-actions">
              <a href="${r.filepath}" target="_blank" class="btn-view" title="View PDF">
                <i class="bi bi-eye"></i>
              </a>
              <button class="btn-edit" onclick="openEditModal('${r._id}', 'pdf', '${escapeHtml(r.title).replace(/'/g, "\\'")}', '${escapeHtml(r.description || '').replace(/'/g, "\\'")}')" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn-delete" onclick="confirmDelete('${r._id}', '${escapeHtml(r.title)}')" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      }
      
      // Videos section
      if (videos.length > 0) {
        html += `<h3 class="resource-type-header"><i class="bi bi-play-circle"></i> Videos (${videos.length})</h3>`;
        html += videos.map(r => `
          <div class="resource-card video" data-id="${r._id}">
            <div class="resource-icon video-icon-bg">
              <i class="bi bi-play-circle-fill"></i>
            </div>
            <div class="resource-info">
              <h3>${escapeHtml(r.title)}</h3>
              <p>${escapeHtml(r.description || 'No description')}</p>
              <div class="resource-meta">
                <span><i class="bi bi-link-45deg"></i> <a href="${escapeHtml(r.video_url)}" target="_blank" class="video-link">${truncateUrl(r.video_url)}</a></span>
                <span><i class="bi bi-person"></i> ${escapeHtml(r.uploaded_by || 'Unknown')}</span>
              </div>
            </div>
            <div class="resource-actions">
              <a href="${escapeHtml(r.video_url)}" target="_blank" class="btn-view btn-watch" title="Watch Video">
                <i class="bi bi-play-fill"></i>
              </a>
              <button class="btn-edit" onclick="openEditModal('${r._id}', 'video', '${escapeHtml(r.title).replace(/'/g, "\\'")}', '${escapeHtml(r.description || '').replace(/'/g, "\\'")}', '${escapeHtml(r.video_url || '').replace(/'/g, "\\'")}')" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn-delete" onclick="confirmDelete('${r._id}', '${escapeHtml(r.title)}')" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      }
      
      resourcesList.innerHTML = html;
      
    } catch (error) {
      console.error('Error loading resources:', error);
      resourcesList.innerHTML = `
        <div class="error-state">
          <i class="bi bi-exclamation-circle"></i>
          <p>Could not load resources. Please refresh the page.</p>
        </div>
      `;
    }
  }

  // Truncate long URLs for display
  function truncateUrl(url) {
    if (!url) return '';
    if (url.length > 40) {
      return url.substring(0, 40) + '...';
    }
    return url;
  }

  // Confirm delete
  window.confirmDelete = function(id, title) {
    deleteResourceId = id;
    document.getElementById('deleteResourceTitle').textContent = title;
    deleteModal.show();
  };

  // Open edit modal
  window.openEditModal = function(id, type, title, description, videoUrl = '') {
    document.getElementById('editResourceId').value = id;
    document.getElementById('editResourceType').value = type;
    document.getElementById('editTitle').value = title;
    document.getElementById('editDescription').value = description;
    
    // Show/hide video URL field based on resource type
    const videoUrlGroup = document.getElementById('editVideoUrlGroup');
    const videoUrlInput = document.getElementById('editVideoUrl');
    
    if (type === 'video') {
      videoUrlGroup.style.display = 'block';
      videoUrlInput.value = videoUrl;
    } else {
      videoUrlGroup.style.display = 'none';
      videoUrlInput.value = '';
    }
    
    editModal.show();
  };

  // Save edit changes
  document.getElementById('confirmEditBtn').addEventListener('click', async () => {
    const resourceId = document.getElementById('editResourceId').value;
    const resourceType = document.getElementById('editResourceType').value;
    const title = document.getElementById('editTitle').value.trim();
    const description = document.getElementById('editDescription').value.trim();
    const videoUrl = document.getElementById('editVideoUrl').value.trim();
    
    if (!title) {
      showMessage('Title is required.', true);
      return;
    }
    
    const token = localStorage.getItem('token');
    if (!token) {
      showMessage('Please log in to edit resources.', true);
      return;
    }
    
    const confirmBtn = document.getElementById('confirmEditBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
    
    const updateData = {
      title: title,
      description: description
    };
    
    // Include video_url for video resources
    if (resourceType === 'video' && videoUrl) {
      updateData.video_url = videoUrl;
    }
    
    try {
      const response = await fetch(`/api/resources/${resourceId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(updateData)
      });
      
      const data = await response.json();
      
      if (response.ok) {
        editModal.hide();
        showMessage('Resource updated successfully!', false);
        loadResources();
      } else {
        showMessage(data.message || 'Update failed.', true);
      }
    } catch (error) {
      console.error('Edit error:', error);
      showMessage('Could not update resource.', true);
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save Changes';
    }
  });

  // Delete resource
  document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
    if (!deleteResourceId) return;
    
    const token = localStorage.getItem('token');
    
    try {
      const response = await fetch(`/api/resources/${deleteResourceId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });
      
      const data = await response.json();
      
      if (response.ok) {
        deleteModal.hide();
        showMessage('Resource deleted successfully!', false);
        loadResources();
      } else {
        showMessage(data.message || 'Delete failed.', true);
      }
    } catch (error) {
      console.error('Delete error:', error);
      showMessage('Could not delete resource.', true);
    }
    
    deleteResourceId = null;
  });

  // Show message helper
  function showMessage(message, isError) {
    uploadMessage.textContent = message;
    uploadMessage.className = 'upload-message ' + (isError ? 'error' : 'success');
    uploadMessage.style.display = 'block';
    
    setTimeout(() => {
      uploadMessage.style.display = 'none';
    }, 5000);
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  // Menu controls
  menuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    sideMenu.classList.add('open');
    sideMenu.setAttribute('aria-hidden', 'false');
  });

  closeMenu.addEventListener('click', (e) => {
    e.stopPropagation();
    sideMenu.classList.remove('open');
    sideMenu.setAttribute('aria-hidden', 'true');
  });

  document.addEventListener('click', (e) => {
    if (!sideMenu.contains(e.target) && e.target !== menuBtn) {
      sideMenu.classList.remove('open');
      sideMenu.setAttribute('aria-hidden', 'true');
    }
  });

  // User popup
  userBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    userPopup.classList.toggle('active');
  });

  document.addEventListener('click', (e) => {
    if (!userPopup.contains(e.target) && e.target !== userBtn) {
      userPopup.classList.remove('active');
    }
  });
})();
</script>

<!-- Custom Leaf Cursor -->
<script src="{{ url_for('static', filename='custom-cursor.js') }}"></script>

</body>
</html>

