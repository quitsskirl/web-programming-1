<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mental Health | Settings</title>
  
  <!-- ==================== BOOTSTRAP CSS ==================== -->
  <!-- Bootstrap 5: provides form styling, buttons, modals, cards -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Link to settings page styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='Settings1.css') }}">
  <!-- Feedback Popup Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='feedback-popup.css') }}">
  <!-- Custom Leaf Cursor -->
  <link rel="stylesheet" href="{{ url_for('static', filename='custom-cursor.css') }}">
</head>
<body>

  <!-- ========== LOADING SCREEN ========== -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-content">
      <div class="leaf-loader">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>
      <p class="loading-text">Loading<span class="dots"></span></p>
    </div>
  </div>

  <!-- ========== HEADER ========== -->
  <header>
    <div class="header-left">
      <button id="menuBtn" class="menu-icon" title="Open Menu">&#9776;</button>
      <h2>Settings</h2>
    </div>
    <div class="header-right">
      <button id="chatBtn" class="chat-icon" title="Open Chat">üí¨</button>
    </div>
  </header>

  <!-- ========== SIDE NAVIGATION MENU ========== -->
  <nav id="sideMenu" class="side-menu" aria-hidden="true">
    <button id="closeMenu" class="close-btn" title="Close Menu">&times;</button>
    <h3>Menu</h3>
    <a href="{{ url_for('home.home_page') }}">üè† Home Page</a>
    <a href="{{ url_for('services.services_page') }}">üõ†Ô∏è Services</a>
    <a href="{{ url_for('classifier.support_classifier_page') }}">ü§ñ Support Classifier</a>
    <a href="{{ url_for('resources.resources_page') }}">üìö Resources</a>
    <a href="{{ url_for('appointments.book_appointment') }}">üìÖ Book Appointment</a>
    <a href="{{ url_for('appointments.student_appointments') }}">üìã My Appointments</a>
    <a class="active" href="{{ url_for('settings.settings_page') }}">‚öôÔ∏è Settings</a>
  </nav>

  <!-- ========== MAIN CONTENT ========== -->
  <main class="container">

    <!-- ===== PROFILE INFO BOX ===== -->
    <!-- Displays current user's account info -->
    <section class="profile-box">
      <h3><i class="bi bi-person-circle"></i> Account Info</h3>
      <p><strong>Username:</strong> <span id="profileUsername">Loading...</span></p>
      <p><strong>Tags:</strong> <span id="profileTags">Loading...</span></p>
    </section>

    <!-- ===== ACCOUNT SETTINGS ===== -->
    <section class="account-settings">
      <h3><i class="bi bi-shield-lock"></i> Security & Preferences</h3>
      
      <!-- Setting action buttons -->
      <button class="primary" id="btnChangePass">
        <i class="bi bi-key"></i> Change Password
      </button>
      <button class="primary" id="btnNotifications">
        <i class="bi bi-bell"></i> Notification Preferences
      </button>
      <button class="primary" id="btnBlocked">
        <i class="bi bi-person-x"></i> Manage Blocked Users
      </button>

      <!-- Hidden form: Change Password -->
      <div class="hidden-form" id="formChangePass">
        <h4><i class="bi bi-lock"></i> Change Password</h4>
        <form>
          <label for="oldPass">Current Password</label>
          <div class="password-input-wrapper">
            <input type="password" id="oldPass" name="oldPass" placeholder="Enter current password" required>
            <button type="button" class="toggle-password" data-target="oldPass" title="Show password">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          <label for="newPass">New Password</label>
          <div class="password-input-wrapper">
            <input type="password" id="newPass" name="newPass" placeholder="Enter new password" required>
            <button type="button" class="toggle-password" data-target="newPass" title="Show password">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          <button type="submit" class="primary">
            <i class="bi bi-check-lg"></i> Update Password
          </button>
        </form>
      </div>

      <!-- Hidden form: Notification Settings -->
      <div class="hidden-form" id="formNotifications">
        <h4><i class="bi bi-bell"></i> Notification Preferences</h4>
        <form>
          <label><input type="checkbox" name="emailNot" checked> Email notifications for updates</label>
          <label><input type="checkbox" name="smsNot"> SMS notifications</label>
          <label><input type="checkbox" name="reminderNot" checked> Appointment reminders</label>
          <button type="submit" class="primary">
            <i class="bi bi-check-lg"></i> Save Preferences
          </button>
        </form>
      </div>

      <!-- Hidden form: Blocked Users -->
      <div class="hidden-form" id="formBlocked">
        <h4><i class="bi bi-person-x"></i> Blocked Users</h4>
        <p style="color: #6b7055; margin-bottom: 16px;">You currently have no blocked users.</p>
        <button type="button" class="primary">
          <i class="bi bi-gear"></i> Manage Block List
        </button>
      </div>
    </section>

    <!-- ===== DANGER ZONE ===== -->
    <!-- Account deletion and logout -->
    <section class="danger-zone">
      <h3><i class="bi bi-exclamation-triangle"></i> Activity</h3>
      <div class="button-group">
        <button class="delete-btn" id="btnDeleteAccount">
          <i class="bi bi-trash"></i> Delete Account
        </button>
        <button class="logout-btn" id="btnLogOut">
          <i class="bi bi-box-arrow-right"></i> Log Out
        </button>
      </div>
    </section>

  </main>

  <!-- Password toggle styles -->
  <style>
    .password-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .password-input-wrapper input {
      flex: 1;
      padding-right: 40px;
    }
    .toggle-password {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      color: #6b7055;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .toggle-password:hover {
      color: #4a5d23;
    }
    .toggle-password i {
      font-size: 1.1rem;
    }
  </style>

  <!-- Loading screen script -->
  <script>
    window.addEventListener('load', function() {
      const loadingScreen = document.getElementById('loadingScreen');
      setTimeout(function() {
        loadingScreen.classList.add('hidden');
      }, 800);
    });
  </script>
  
  <!-- External JS file for settings functionality -->
  <script src="{{ url_for('static', filename='Settings.js') }}"></script>
  
  <!-- Password visibility toggle -->
  <script>
    document.querySelectorAll('.toggle-password').forEach(btn => {
      btn.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const input = document.getElementById(targetId);
        const icon = this.querySelector('i');
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('bi-eye');
          icon.classList.add('bi-eye-slash');
          this.title = 'Hide password';
        } else {
          input.type = 'password';
          icon.classList.remove('bi-eye-slash');
          icon.classList.add('bi-eye');
          this.title = 'Show password';
        }
      });
    });
  </script>
  
  <!-- ==================== BOOTSTRAP JAVASCRIPT ==================== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- ==================== DELETE ACCOUNT FUNCTIONALITY ==================== -->
  <!-- This script handles the account deletion using the DELETE API endpoint -->
  <script>
    document.getElementById('btnDeleteAccount').addEventListener('click', async () => {
      // Bootstrap-style confirm using window.confirm (could use a modal instead)
      if (!confirm('Are you sure you want to delete your account? This action cannot be undone!')) {
        return;
      }
      
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('role') || 'student';
      
      if (!token) {
        alert('You must be logged in to delete your account.');
        return;
      }
      
      // Determine the correct endpoint based on user role
      const endpoint = role === 'professional' 
        ? '/api/professional/delete' 
        : '/api/student/delete';
      
      try {
        // Call the DELETE API endpoint
        const response = await fetch(endpoint, {
          method: 'DELETE',  // HTTP DELETE method for removing resources
          headers: {
            'Authorization': 'Bearer ' + token  // JWT token for authentication
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert(data.message);
          // Clear localStorage, cookie and redirect to first page
          localStorage.clear();
          document.cookie = 'jwt_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
          window.location.href = '/';
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Could not delete account. Please try again.');
      }
    });
  </script>

  <!-- Feedback Popup System -->
  <script src="{{ url_for('static', filename='feedback-popup.js') }}"></script>

  <!-- Custom Leaf Cursor -->
  <script src="{{ url_for('static', filename='custom-cursor.js') }}"></script>

</body>
</html>
